# 📝 Copalny AI 提示詞與回應處理流程說明

## 🎯 目前 AI 提示詞設計

### 1. 文字輸入模式
**提示詞模板：**
```
請將以下任務分解為清晰、可執行的步驟列表。任務是：「${goal}」。請生成 3-8 個步驟，每個步驟用編號標示，例如：1. 步驟標題 2. 步驟標題等。
```

**特點：**
- 要求生成 3-8 個步驟（智能範圍）
- 指定編號格式：`1. 步驟標題`
- 移除複雜的JSON格式要求
- 簡潔明瞭的指令

### 2. 圖片輸入模式
**有文字描述時：**
```
請分析這張圖片，並根據用戶的需求「${goal}」來生成具體可執行的步驟列表。請生成 3-8 個步驟，每個步驟用編號標示，例如：1. 步驟標題 2. 步驟標題等。
```

**只有圖片時：**
```
請分析這張圖片，並根據圖片內容生成相關的專案流程步驟。請生成 3-8 個步驟，每個步驟用編號標示，例如：1. 步驟標題 2. 步驟標題等。
```

### 3. 步驟解釋功能
**提示詞模板：**
```
作為一名資深技術導師，請詳細解釋以下軟體開發或專案管理中的步驟。步驟是：「${selectedItem.text}」。

請提供：
1. 這是什麼的詳細解釋
2. 為什麼它很重要
3. 如果需要視覺化說明，請用以下方式之一呈現：
   - ASCII art簡單圖表
   - Mermaid圖表代碼（流程圖、時序圖等）
   - 簡單的文字圖示
   - 代碼示例

請用清晰易懂的方式回答，並在適當時機提供視覺化說明。
```

---

## 🔄 AI 回應處理流程

### 階段 1: 發送請求
```
用戶輸入 → 構建提示詞 → 調用 Gemini API → 獲取回應
```

### 階段 2: 解析回應
**使用 `parseNaturalLanguageSteps()` 函數：**

#### 解析策略（按優先級）：
1. **編號格式解析**（最高優先級）
   - 匹配模式：`/^\d+\.\s*(.+)$/gm`
   - 示例：`1. 需求分析 2. 系統設計 3. 開發實現`

2. **標題:描述格式**（備用策略）
   - 匹配模式：`/^(.+?)[:：](.+)$/gm`
   - 示例：`需求分析: 收集用戶需求` → `需求分析: 收集用戶需求`

3. **段落分割**（最終備用）
   - 按空行分割：`text.split(/\n\s*\n/)`
   - 每個非空段落作為一個步驟

#### 限制條件：
- 最多解析 10 個步驟
- 過濾空內容
- 自動去除前後空白

### 階段 3: UI 更新流程
```
解析結果 → 更新 currentTexts 陣列 → 調用 createItems() → 重新繪製畫布
```

#### UI 狀態變化：
1. **載入狀態**：顯示旋轉動畫，禁用按鈕
2. **成功狀態**：
   - `isInitialState = false`（解除初始提示）
   - 創建新的步驟項目
   - 自動排列在畫布上
3. **失敗狀態**：顯示錯誤提示，恢復按鈕狀態

---

## 🎨 實際使用示例

### 示例 1: 文字輸入
**用戶輸入：** "開發一個待辦事項應用"
**AI 回應：**
```
1. 需求分析與設計
2. 設置開發環境
3. 創建用戶介面
4. 實現核心功能
5. 測試與部署
```

**解析結果：** 5 個步驟，顯示在畫布上

### 示例 2: 圖片 + 文字
**用戶輸入：** "分析這張流程圖，優化業務流程"
**AI 回應：**
```
基於圖片分析，建議以下優化步驟：

1. 簡化審批流程
2. 增加自動化處理
3. 優化資源分配
4. 建立監控機制
```

**解析結果：** 4 個步驟，顯示在畫布上

---

## 🔧 技術實現細節

### 錯誤處理
- **網路錯誤**：重試 3 次 + 指數退避
- **解析失敗**：顯示 "無法解析 AI 回應，請重試"
- **API 錯誤**：顯示 "無法從 AI 獲取步驟，請檢查網路"

### 效能優化
- 非同步處理，不阻塞 UI
- 載入狀態指示器
- 智能步驟數量控制（3-8 個）

### 擴展性
- 支持圖片分析（多模態）
- 靈活的解析策略
- 易於添加新的提示詞模板

---

## 📊 流程圖

```
用戶輸入
    ↓
構建提示詞 (handleGenerateSteps)
    ↓
調用 Gemini API (callGeminiAPI)
    ↓
接收自然語言回應
    ↓
解析步驟 (parseNaturalLanguageSteps)
    ↓
更新 UI (createItems)
    ↓
顯示結果
```

---
*版本: 1.0 | 更新: 2025年9月23日*